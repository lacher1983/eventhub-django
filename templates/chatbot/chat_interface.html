{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid chat-interface-container">
    <div class="row h-100">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –±—ã—Å—Ç—Ä—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ -->
        <div class="col-md-3 col-lg-2 sidebar-chat-commands">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">üöÄ –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã</h6>
                </div>
                <div class="card-body p-3">
                    <div class="quick-commands">
                        <h6 class="text-muted mb-2">üîç –ü–æ–∏—Å–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h6>
                        <button class="btn btn-outline-primary btn-sm w-100 mb-2 text-start" 
                                data-quick-message="–ù–∞–π–¥–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≤–µ–±–∏–Ω–∞—Ä—ã –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ">
                            üéì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≤–µ–±–∏–Ω–∞—Ä—ã
                        </button>
                        <button class="btn btn-outline-primary btn-sm w-100 mb-2 text-start"
                                data-quick-message="–ö–∞–∫–∏–µ IT –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –µ—Å—Ç—å –≤ –ú–æ—Å–∫–≤–µ?">
                            üíª IT –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
                        </button>
                        <button class="btn btn-outline-primary btn-sm w-100 mb-2 text-start"
                                data-quick-message="–ü–æ–∫–∞–∂–∏ –∫–æ–Ω—Ü–µ—Ä—Ç—ã –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ">
                            üéµ –ö–æ–Ω—Ü–µ—Ä—Ç—ã
                        </button>
                        
                        <h6 class="text-muted mb-2 mt-3">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h6>
                        <button class="btn btn-outline-info btn-sm w-100 mb-2 text-start"
                                data-quick-message="–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ?">
                            üìç –°–µ–≥–æ–¥–Ω—è
                        </button>
                        <button class="btn btn-outline-info btn-sm w-100 mb-2 text-start"
                                data-quick-message="–ö–∞–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞?">
                            üóìÔ∏è –ó–∞–≤—Ç—Ä–∞
                        </button>
                        
                        <h6 class="text-muted mb-2 mt-3">‚ùì –ü–æ–º–æ—â—å</h6>
                        <button class="btn btn-outline-secondary btn-sm w-100 mb-2 text-start"
                                data-quick-message="–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?">
                            ‚ùì –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
                        </button>
                        <button class="btn btn-outline-secondary btn-sm w-100 mb-2 text-start"
                                data-quick-message="–ö–∞–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?">
                            üé´ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                        </button>
                    </div>
                    
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Ç–∞ -->
                    <div class="chat-stats mt-4 p-3 bg-light rounded">
                        <h6 class="text-muted">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h6>
                        <div class="stats-item">
                            <small>–°–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è: <span id="messages-today">0</span></small>
                        </div>
                        <div class="stats-item">
                            <small>–ù–∞–π–¥–µ–Ω–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: <span id="events-found">0</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="col-md-9 col-lg-10 main-chat-area">
            <div class="card h-100">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
                <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="chatbot-avatar me-3">
                            <span>ü§ñ</span>
                        </div>
                        <div>
                            <h5 class="mb-0">EventHub AI –ü–æ–º–æ—â–Ω–∏–∫</h5>
                            <small class="opacity-75">–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ø–æ–∏—Å–∫–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π!</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2" id="connection-status">
                            <i class="fas fa-circle me-1"></i>Online
                        </span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" id="clear-chat-btn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-light" id="export-chat-btn" title="–≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
                <div class="card-body p-0 d-flex flex-column">
                    <div id="chat-messages" class="chat-messages-container flex-grow-1 p-3">
                        <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                        <div class="welcome-message alert alert-info border-0">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <div class="avatar-circle bg-primary text-white">ü§ñ</div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h5 class="alert-heading">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ EventHub AI!</h5>
                                    <p class="mb-2">–Ø –≤–∞—à —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π. –í–æ—Ç —á—Ç–æ —è –º–æ–≥—É:</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <ul class="mb-2">
                                                <li>üéØ <strong>–ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π</strong> –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</li>
                                                <li>üìÖ <strong>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è</strong> –ø–æ –¥–∞—Ç–µ –∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é</li>
                                                <li>üí∞ <strong>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ</strong> –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="mb-2">
                                                <li>üë• <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</strong> –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º</li>
                                                <li>üé´ <strong>–ü–æ–º–æ—â—å</strong> —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</li>
                                                <li>üì± <strong>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong> –æ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <small class="text-muted">–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä: <em>"–ù–∞–π–¥–∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ñ–µ—Å—Ç–∏–≤–∞–ª–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ"</em></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è -->
                    <div class="quick-suggestions border-top bg-light p-3" id="quick-suggestions">
                        <small class="text-muted d-block mb-2">üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å:</small>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-primary" data-quick-message="–ö–∞–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å–µ–≥–æ–¥–Ω—è?">
                                üìç –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
                            </button>
                            <button class="btn btn-sm btn-outline-primary" data-quick-message="–ü–æ–∫–∞–∂–∏ –±–ª–∏–∂–∞–π—à–∏–µ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏">
                                üé§ –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏
                            </button>
                            <button class="btn btn-sm btn-outline-primary" data-quick-message="–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã">
                                üé® –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã
                            </button>
                        </div>
                    </div>
                    
                    <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
                    <div class="chat-input-container border-top bg-white p-3">
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" id="attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (—Å–∫–æ—Ä–æ)">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="text" 
                                   id="message-input" 
                                   class="form-control border-0" 
                                   placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏)"
                                   aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ">
                            <button class="btn btn-outline-secondary" type="button" id="voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ (—Å–∫–æ—Ä–æ)">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="btn btn-primary" type="button" id="send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="mt-2 d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <span id="typing-indicator" class="d-none">
                                    <i class="fas fa-typing"></i> –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–µ—á–∞—Ç–∞–µ—Ç...
                                </span>
                            </small>
                            <small class="text-muted">
                                –°–æ–æ–±—â–µ–Ω–∏–µ: <span id="char-count">0</span>/1000
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üì§ –≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞:</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" id="export-text-btn">
                        <i class="fas fa-file-text me-2"></i>–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª (.txt)
                    </button>
                    <button class="btn btn-outline-success" id="export-pdf-btn">
                        <i class="fas fa-file-pdf me-2"></i>PDF –¥–æ–∫—É–º–µ–Ω—Ç
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* –°–¢–ò–õ–ò –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô –ß–ê–¢–ê - –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û–¢ –ë–õ–û–ö */
.message {
    margin-bottom: 1rem;
    display: flex;
    animation: fadeIn 0.3s ease;
}

.message-user {
    justify-content: flex-end;
}

.message-bot {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    word-wrap: break-word;
}

.message-bubble.user {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-bottom-right-radius: 5px;
}

.message-bubble.bot {
    background: white;
    border: 1px solid #e0e0e0;
    border-bottom-left-radius: 5px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.message-text {
    line-height: 1.4;
    margin-bottom: 4px;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    text-align: right;
}

.typing-animation {
    display: flex;
    gap: 4px;
    align-items: center;
    padding: 8px 0;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: #999;
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-5px); opacity: 1; }
}

.chat-messages-container {
    background: #f8f9fa;
    min-height: 400px;
    max-height: 60vh;
    overflow-y: auto;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

let messagesToday = 0;
let eventsFound = 0;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Chat initialized');
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è session_id
    currentSessionId = 'chat_session_' + Date.now();
    console.log('üÜî Session ID:', currentSessionId);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    setupEventListeners();
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const input = document.getElementById('message-input');
    if (input) {
        input.focus();
        console.log('‚úÖ Input focused');
    }
});

function setupEventListeners() {
    const sendBtn = document.getElementById('send-btn');
    const voiceBtn = document.getElementById('voice-btn');
    const messageInput = document.getElementById('message-input');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const exportChatBtn = document.getElementById('export-chat-btn');
    const attachBtn = document.getElementById('attach-btn');
    const exportTextBtn = document.getElementById('export-text-btn');
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    
    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
        console.log('‚úÖ Send button handler added');
    }
    
    // –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
    if (voiceBtn) {
        voiceBtn.addEventListener('click', function() {
            alert('üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!');
        });
    }
    
    // –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    if (attachBtn) {
        attachBtn.addEventListener('click', function() {
            alert('üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!');
        });
    }
    
    // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞
    if (clearChatBtn) {
        clearChatBtn.addEventListener('click', clearChat);
    }
    
    // –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —á–∞—Ç–∞
    if (exportChatBtn) {
        exportChatBtn.addEventListener('click', function() {
            const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
            exportModal.show();
        });
    }
    
    // –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    if (exportTextBtn) {
        exportTextBtn.addEventListener('click', exportChatAsText);
    }
    
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', exportChatAsPDF);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    const quickMessageBtns = document.querySelectorAll('[data-quick-message]');
    quickMessageBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const message = this.getAttribute('data-quick-message');
            quickMessage(message);
        });
    });
    console.log(`‚úÖ ${quickMessageBtns.length} quick message buttons handlers added`);
    
    // –ü–æ–ª–µ –≤–≤–æ–¥–∞ - –æ–±—Ä–∞–±–æ—Ç–∫–∞ Enter
    if (messageInput) {
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
        messageInput.addEventListener('input', function() {
            document.getElementById('char-count').textContent = this.value.length;
        });
    }
    
    console.log('‚úÖ All event listeners setup complete');
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage() {
    console.log('üöÄ === SEND MESSAGE STARTED ===');
    
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    const sendBtn = document.getElementById('send-btn');
    
    if (!message) {
        console.log('‚ùå Empty message, skipping');
        return;
    }
    
    console.log('üìù Message to send:', message);
    console.log('üÜî Session ID:', currentSessionId);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
    addMessageToChat(message, 'user');
    input.value = '';
    document.getElementById('char-count').textContent = '0';
    sendBtn.disabled = true;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
    showTypingIndicator();
    
    try {
        console.log('üì° Making API request to /chatbot/api/chat/');

        const csrfToken = getCSRFToken();
        console.log('üîê CSRF token:', csrfToken ? 'Found' : 'NOT FOUND!');

        const requestBody = {
            message: message,
            session_id: currentSessionId
        };

        console.log('üì¶ Request body:', requestBody);
        
        const response = await fetch('/chatbot/api/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify(requestBody)
        });
        
        console.log('üì® Response received');
        console.log('üìä Status:', response.status);
        console.log('‚úÖ OK:', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Response error:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìã Response data:', data);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
        hideTypingIndicator();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
        addMessageToChat(data.response, 'bot', data);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        messagesToday++;
        document.getElementById('messages-today').textContent = messagesToday;
        
        if (data.events && data.events.length > 0) {
            eventsFound += data.events.length;
            document.getElementById('events-found').textContent = eventsFound;
        }
        
        if (data.suggestions && data.suggestions.length > 0) {
            showQuickSuggestions(data.suggestions);
        }
        
        console.log('‚úÖ Message processed successfully');
        
    } catch (error) {
        console.error('üí• Chat error:', error);
        console.error('üí• Error details:', error.message);
        console.error('üí• Stack:', error.stack);
        
        hideTypingIndicator();
        addMessageToChat('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message, 'bot');
    } finally {
        sendBtn.disabled = false;
        input.focus();
        console.log('üîÑ Send button re-enabled');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
function quickMessage(message) {
    console.log('‚ö° Quick message:', message);
    const input = document.getElementById('message-input');
    if (input) {
        input.value = message;
        sendMessage();
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞
function clearChat() {
    console.log('üóëÔ∏è Clearing chat...');
    
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
        const messagesContainer = document.getElementById('chat-messages');
        if (messagesContainer) {
            messagesContainer.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            messagesContainer.innerHTML = `
                <div class="welcome-message alert alert-info border-0">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <div class="avatar-circle bg-primary text-white">ü§ñ</div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">–ß–∞—Ç –æ—á–∏—â–µ–Ω!</h5>
                            <p>–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</p>
                        </div>
                    </div>
                </div>
            `;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            messagesToday = 0;
            eventsFound = 0;
            document.getElementById('messages-today').textContent = '0';
            document.getElementById('events-found').textContent = '0';
            
            console.log('‚úÖ Chat cleared');
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ç–µ–∫—Å—Ç
function exportChatAsText() {
    console.log('üìÑ Exporting chat as text...');
    alert('üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!');
}

// –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF
function exportChatAsPDF() {
    console.log('üìä Exporting chat as PDF...');
    alert('üìä PDF —ç–∫—Å–ø–æ—Ä—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!');
}

// –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessageToChat(content, type, data = null) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) {
        console.error('‚ùå Messages container not found!');
        return;
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = `message-bubble ${type}`;
    
    const time = new Date().toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    let messageContent = content;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
    if (type === 'bot') {
        messageContent = content
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }
    
    bubbleDiv.innerHTML = `
        <div class="message-text">${messageContent}</div>
        <div class="message-time">${time}</div>
    `;
    
    messageDiv.appendChild(bubbleDiv);
    messagesContainer.appendChild(messageDiv);
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    console.log('‚úÖ Message added to chat:', type);
}

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
function showTypingIndicator() {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message message-bot';
    typingDiv.id = 'typing-indicator';
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble bot';
    
    bubbleDiv.innerHTML = `
        <div class="typing-animation">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    
    typingDiv.appendChild(bubbleDiv);
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    console.log('‚å®Ô∏è Typing indicator shown');
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
        console.log('‚å®Ô∏è Typing indicator hidden');
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
function showQuickSuggestions(suggestions) {
    console.log('üí° Showing suggestions:', suggestions);
    const suggestionsContainer = document.getElementById('quick-suggestions');
    
    if (suggestionsContainer) {
        let html = '<small class="text-muted d-block mb-2">üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å:</small>';
        html += '<div class="d-flex flex-wrap gap-2">';
        
        suggestions.forEach(suggestion => {
            html += `<button class="btn btn-sm btn-outline-primary" data-quick-message="${suggestion}">${suggestion}</button>`;
        });
        
        html += '</div>';
        suggestionsContainer.innerHTML = html;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
        const newBtns = document.querySelectorAll('#quick-suggestions [data-quick-message]');
        newBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const message = this.getAttribute('data-quick-message');
                quickMessage(message);
            });
        });
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) {
        return token.value;
    }
    console.warn('‚ö†Ô∏è CSRF token not found!');
    return '';
}

// –°–¥–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
window.quickMessage = quickMessage;
window.clearChat = clearChat;
window.sendMessage = sendMessage;

console.log('‚úÖ All JavaScript functions loaded successfully');
</script>
{% endblock %}