{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>üêõ –û—Ç–ª–∞–¥–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã</h2>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—Ä–∑–∏–Ω–µ</h5>
                </div>
                <div class="card-body">
                    <p><strong>ID –∫–æ—Ä–∑–∏–Ω—ã:</strong> {{ cart.id }}</p>
                    <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> {{ cart.user.username }}</p>
                    <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤:</strong> {{ cart_count }}</p>
                    <p><strong>–û–±—â–∞—è —Å—É–º–º–∞:</strong> {{ cart_total }} ‚ÇΩ</p>
                    <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> {{ cart.created_at }}</p>
                    <p><strong>–û–±–Ω–æ–≤–ª–µ–Ω–∞:</strong> {{ cart.updated_at }}</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>–¢–µ—Å—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary me-2" onclick="testAjax()">
                        –¢–µ—Å—Ç AJAX –∑–∞–ø—Ä–æ—Å–∞
                    </button>
                    <button class="btn btn-secondary" onclick="testCSRF()">
                        –¢–µ—Å—Ç CSRF —Ç–æ–∫–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>–¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ ({{ cart_items|length }})</h5>
        </div>
        <div class="card-body">
            {% if cart_items %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart_items %}
                    <tr>
                        <td>{{ item.id }}</td>
                        <td>{{ item.event.title }}</td>
                        <td>{{ item.price }} ‚ÇΩ</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.total_price }} ‚ÇΩ</td>
                        <td>
                            <button class="btn btn-sm btn-success" 
                                    onclick="testUpdate({{ item.id }}, 'increase')">+</button>
                            <button class="btn btn-sm btn-warning" 
                                    onclick="testUpdate({{ item.id }}, 'decrease')">-</button>
                            <button class="btn btn-sm btn-danger" 
                                    onclick="testRemove({{ item.id }})">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
            {% endif %}
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>Raw SQL –∑–∞–ø—Ä–æ—Å</h5>
        </div>
        <div class="card-body">
            <pre>CartItem.objects.filter(cart={{ cart.id }}).select_related('event')</pre>
            <p>–ù–∞–π–¥–µ–Ω–æ: {{ all_cart_items.count }} –∑–∞–ø–∏—Å–µ–π</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –¢–µ—Å—Ç AJAX –∑–∞–ø—Ä–æ—Å–∞
function testAjax() {
    const csrfToken = getCookie('csrftoken');
    console.log('CSRF Token:', csrfToken);
    
    fetch('/cart/update/999/', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ action: 'increase' })
    })
    .then(response => response.json())
    .then(data => console.log('AJAX Response:', data))
    .catch(error => console.error('AJAX Error:', error));
}

// –¢–µ—Å—Ç CSRF —Ç–æ–∫–µ–Ω–∞
function testCSRF() {
    const token = getCookie('csrftoken');
    alert('CSRF Token: ' + (token ? '‚úÖ –ù–∞–π–¥–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'));
}

// –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
function testUpdate(itemId, action) {
    const csrfToken = getCookie('csrftoken');
    const formData = new FormData();
    formData.append('action', action);
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    console.log('Sending:', { itemId, action });
    
    fetch(`/cart/update/${itemId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Update Response:', data);
        alert('–†–µ–∑—É–ª—å—Ç–∞—Ç: ' + (data.success ? '‚úÖ –£—Å–ø–µ—Ö' : '‚ùå –û—à–∏–±–∫–∞') + '\n' + JSON.stringify(data));
        location.reload();
    })
    .catch(error => {
        console.error('Update Error:', error);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    });
}

// –¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è
function testRemove(itemId) {
    if (confirm('–¢–µ—Å—Ç–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ' + itemId + '?')) {
        const csrfToken = getCookie('csrftoken');
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch(`/cart/remove/${itemId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Remove Response:', data);
            alert('–†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.success ? '‚úÖ –£—Å–ø–µ—Ö' : '‚ùå –û—à–∏–±–∫–∞'));
            location.reload();
        })
        .catch(error => {
            console.error('Remove Error:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
        });
    }
}
</script>
{% endblock %}