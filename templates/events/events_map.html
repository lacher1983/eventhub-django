{% extends 'base.html' %}
{% load static %}

{% block title %}–ö–∞—Ä—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π - EventHub{% endblock %}

{% block yandex_maps %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU"></script>
{% endblock %}

{% block extra_css %}
<link href="{% static 'events/css/map_filters.css' %}" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script src="{% static 'events/js/enhanced_map.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="bg-light py-4 mb-0">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-0">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h1>
                    <p class="text-muted mb-0">
                        {% if events_count > 0 %}
                            ‚úÖ –ù–∞–π–¥–µ–Ω–æ <strong>{{ events_count }}</strong> –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–∞ –∫–∞—Ä—Ç–µ
                        {% else %}
                            ‚ùå –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                            üîß –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="checkStatus()">
                            üìä –°—Ç–∞—Ç—É—Å
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="addTestData()">
                            üìç –¢–µ—Å—Ç
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ë–∞–∑–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
            <div class="row mt-3">
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="category-filter">
                        <option value="all">üéØ –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option value="concert">üéµ –ö–æ–Ω—Ü–µ—Ä—Ç—ã</option>
                        <option value="conference">üíº –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏</option>
                        <option value="workshop">üîß –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</option>
                        <option value="sport">‚öΩ –°–ø–æ—Ä—Ç</option>
                        <option value="exhibition">üñºÔ∏è –í—ã—Å—Ç–∞–≤–∫–∏</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="price-filter">
                        <option value="all">üí∞ –õ—é–±–∞—è —Ü–µ–Ω–∞</option>
                        <option value="free">üé´ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ</option>
                        <option value="paid">üíµ –ü–ª–∞—Ç–Ω—ã–µ</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="date-filter">
                        <option value="all">üìÖ –í—Å–µ –¥–∞—Ç—ã</option>
                        <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="week">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</option>
                        <option value="month">–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="map-search" 
                           placeholder="üîç –ü–æ–∏—Å–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...">
                </div>
            </div>

            <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
            <div class="collapse mt-3" id="advancedFilters">
                <div class="card card-body">
                    <h6 class="card-title">üéõÔ∏è –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">üìç –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞</label>
                            <input type="range" class="form-range" id="radius-filter" min="0" max="50" value="0">
                            <div class="form-text" id="radius-value">–õ—é–±–æ–π —Ä–∞–¥–∏—É—Å</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">‚≠ê –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥</label>
                            <select class="form-select" id="rating-filter">
                                <option value="all">–õ—é–±–æ–π —Ä–µ–π—Ç–∏–Ω–≥</option>
                                <option value="4.5">4.5+ ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                                <option value="4.0">4.0+ ‚≠ê‚≠ê‚≠ê‚≠ê</option>
                                <option value="3.5">3.5+ ‚≠ê‚≠ê‚≠ê</option>
                                <option value="3.0">3.0+ ‚≠ê‚≠ê</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                            <select class="form-select" id="participants-filter">
                                <option value="all">–õ—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
                                <option value="10">10+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</option>
                                <option value="50">50+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</option>
                                <option value="100">100+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</option>
                                <option value="200">200+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="btn-group">
                                <button id="locate-user-btn" class="btn btn-outline-primary btn-sm">
                                    üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetAllFilters()">
                                    üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div id="map" style="width: 100%; height: 75vh; border-radius: 0;"></div>
            </div>
        </div>
    </div>
</div>

<!-- –°–∞–π–¥–±–∞—Ä –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è -->
<div id="event-sidebar" class="event-sidebar"></div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div id="map-stats"></div>

<script>
// –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∏–∑ Django –≤ JavaScript
window.EVENTS_DATA = {{ events_json|safe }};
console.log('=== MAP DATA ===');
console.log('Events loaded:', EVENTS_DATA.length);
console.log('Sample event:', EVENTS_DATA[0]);

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.checkStatus = function() {
    const info = {
        eventsCount: EVENTS_DATA.length,
        mapContainer: document.getElementById('map'),
        ymapsLoaded: typeof ymaps !== 'undefined',
        eventMapInitialized: !!window.eventMap,
        sampleEvent: EVENTS_DATA[0]
    };
    console.log('Status:', info);
    alert(`–°—Ç–∞—Ç—É—Å:\n‚Ä¢ –°–æ–±—ã—Ç–∏–π: ${info.eventsCount}\n‚Ä¢ –ö–∞—Ä—Ç–∞: ${info.mapContainer ? '–ù–ê–ô–î–ï–ù–ê' : '–ù–ï –ù–ê–ô–î–ï–ù–ê'}\n‚Ä¢ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã: ${info.ymapsLoaded ? '–ó–ê–ì–†–£–ñ–ï–ù–´' : '–ù–ï –ó–ê–ì–†–£–ñ–ï–ù–´'}\n‚Ä¢ –ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞: ${info.eventMapInitialized ? '–î–ê' : '–ù–ï–¢'}`);
};

window.addTestData = function() {
    if (window.eventMap && typeof window.eventMap.addEventMarker === 'function') {
        const testEvent = {
            id: 999,
            title: '–¢–ï–°–¢–û–í–´–ô –ú–ê–†–ö–ï–†',
            latitude: 55.76,
            longitude: 37.64,
            location: '–¢–µ—Å—Ç–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è',
            price: 0,
            category_name: '–¢–µ—Å—Ç',
            organizer_name: '–°–∏—Å—Ç–µ–º–∞',
            short_description: '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏',
            average_rating: 4.8,
            registrations_count: 150
        };
        window.eventMap.addEventMarker(testEvent, true);
        alert('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!');
    } else {
        alert('‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    }
};

window.resetAllFilters = function() {
    if (window.eventMap && window.eventMap.filters) {
        window.eventMap.filters.resetFilters();
    } else {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤—Ä—É—á–Ω—É—é
        document.getElementById('category-filter').value = 'all';
        document.getElementById('price-filter').value = 'all';
        document.getElementById('date-filter').value = 'all';
        document.getElementById('map-search').value = '';
        document.getElementById('radius-filter').value = '0';
        document.getElementById('radius-value').textContent = '–õ—é–±–æ–π —Ä–∞–¥–∏—É—Å';
        document.getElementById('rating-filter').value = 'all';
        document.getElementById('participants-filter').value = 'all';
        
        if (window.eventMap) {
            window.eventMap.applyFilters();
        }
    }
    showNotification('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'info');
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing map with', EVENTS_DATA.length, 'events');
    
    if (typeof ymaps === 'undefined') {
        console.error('Yandex Maps not loaded');
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç', 'error');
        return;
    }

    ymaps.ready(function() {
        try {
            initEventMap('map', {
                center: [55.76, 37.64],
                zoom: 10,
                heatmapEnabled: true,
                clusteringEnabled: true,
                eventsData: EVENTS_DATA,
                apiKey: '{{ YANDEX_MAPS_API_KEY }}'
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ —Ä–∞–¥–∏—É—Å–∞
            const radiusSlider = document.getElementById('radius-filter');
            const radiusValue = document.getElementById('radius-value');
            
            if (radiusSlider && radiusValue) {
                radiusSlider.addEventListener('input', function(e) {
                    const radius = parseInt(e.target.value);
                    if (radius === 0) {
                        radiusValue.textContent = '–õ—é–±–æ–π —Ä–∞–¥–∏—É—Å';
                    } else {
                        radiusValue.textContent = `${radius} –∫–º –æ—Ç –≤–∞—Å`;
                    }
                });
            }
            
            console.log('Map initialized successfully');
            
        } catch (error) {
            console.error('Map init error:', error);
            showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã: ' + error.message, 'error');
        }
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
    let notification = document.getElementById('map-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'map-notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease;
        `;
        document.body.appendChild(notification);
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    const styles = {
        'success': { background: '#28a745', icon: '‚úÖ' },
        'error': { background: '#dc3545', icon: '‚ùå' },
        'info': { background: '#17a2b8', icon: '‚ÑπÔ∏è' },
        'warning': { background: '#ffc107', icon: '‚ö†Ô∏è' }
    };
    
    const style = styles[type] || styles.info;
    notification.style.background = style.background;
    notification.innerHTML = `${style.icon} ${message}`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        notification.style.transform = 'translateX(120%)';
    }, 5000);
}
</script>

<style>
.event-sidebar {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    z-index: 1001;
    transition: right 0.3s ease;
    overflow-y: auto;
}

.event-sidebar.active {
    right: 0;
}

.event-sidebar-content {
    padding: 20px;
    position: relative;
}

.close-sidebar {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #666;
}

.map-stats {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(255,255,255,0.95);
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 999;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0,0,0,0.1);
}

.stat-item {
    margin-right: 15px;
    font-size: 0.85em;
    color: #666;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.advanced-filters .card {
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.advanced-filters .card-body {
    padding: 1.25rem;
}

.advanced-filters .form-range::-webkit-slider-thumb {
    background: #007bff;
}

.advanced-filters .form-range::-moz-range-thumb {
    background: #007bff;
}

.advanced-filters .form-range::-webkit-slider-track {
    background: #dee2e6;
}

.advanced-filters .form-range::-moz-range-track {
    background: #dee2e6;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .event-sidebar {
        width: 100%;
        right: -100%;
    }
    
    .map-stats {
        left: 10px;
        bottom: 10px;
        padding: 8px 12px;
    }
    
    .stat-item {
        display: block;
        margin-right: 0;
        margin-bottom: 5px;
    }
    
    .advanced-filters .card-body {
        padding: 1rem;
    }
    
    .btn-group .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
.collapse {
    transition: all 0.3s ease;
}

.btn {
    transition: all 0.2s ease;
}

.form-control, .form-select, .form-range {
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    border-color: #007bff;
}
</style>
{% endblock %}